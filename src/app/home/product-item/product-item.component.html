<app-product-item-shimmer *ngIf="isLoading"></app-product-item-shimmer>

<div class="product-card">

    <div class="add-review-section" *ngIf="isuserloggedin">
        <button class="add-review-btn" (click)="toggleReviewForm()">
            {{ showReviewForm ? 'Hide Review' : 'Add Review' }}
        </button>
    </div>

    <!-- Slide-down Review Form -->
    <div class="modal-overlay" *ngIf="showReviewForm" (click)="closeReviewFormModal()">
        <div class="modal-container" (click)="$event.stopPropagation()">
            <button class="modal-close-btn" (click)="closeReviewFormModal()">√ó</button>

            <div class="review-form-wrapper">
                <form [formGroup]="reviewForm" (ngSubmit)="submitReview()">

                    <div class="form-group">
                        <label>Are you using commercial/personal?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" formControlName="ispaidtogglecommercialorpersonal" value="yes"
                                    (change)="togglecommercialorpersonal(true)" />
                                Commercial
                            </label>
                            <label>
                                <input type="radio" formControlName="ispaidtogglecommercialorpersonal" value="no"
                                    (change)="togglecommercialorpersonal(false)" />
                                Personal
                            </label>
                        </div>
                    </div>

                    <!-- Duration of Usage -->
                    <div class="form-group">
                        <label>How long have you been using this?</label>
                        <select formControlName="usageDuration">
                            <option value="">Select duration</option>
                            <option value="1-2 years">1 to 2 years</option>
                            <option value="2-5 years">2 to 5 years</option>
                            <option value="5+ years">More than 5 years</option>
                        </select>
                    </div>

                    <!-- Experience Rating -->
                    <div class="form-group">
                        <label>How is your experience?</label>
                        <div class="star-rating">
                            <i *ngFor="let star of ratings" class="star"
                                [class.filled]="star <= reviewForm.get('experienceRating')?.value"
                                (click)="setRating('experienceRating', star)">‚òÖ</i>
                            <span class="rating-text">{{ reviewForm.get('experienceRating')?.value }}/5</span>
                        </div>
                    </div>

                    <!-- Efficiency Rating -->
                    <div class="form-group">
                        <label>How is the efficiency of the tool?</label>
                        <div class="star-rating">
                            <i *ngFor="let star of ratings" class="star"
                                [class.filled]="star <= reviewForm.get('efficiencyRating')?.value"
                                (click)="setRating('efficiencyRating', star)">‚òÖ</i>
                            <span class="rating-text">{{ reviewForm.get('efficiencyRating')?.value }}/5</span>
                        </div>
                    </div>

                    <!-- Documentation Quality -->
                    <div class="form-group">
                        <label>How is the documentation quality?</label>
                        <div class="star-rating">
                            <i *ngFor="let star of ratings" class="star"
                                [class.filled]="star <= reviewForm.get('documentationRating')?.value"
                                (click)="setRating('documentationRating', star)">‚òÖ</i>
                            <span class="rating-text">{{ reviewForm.get('documentationRating')?.value }}/5</span>
                        </div>
                    </div>

                    <!-- Paid Version -->
                    <div class="form-group">
                        <label>Are you using paid version?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" formControlName="isPaid" value="yes"
                                    (change)="togglePaidRating(true)" />
                                Yes
                            </label>
                            <label>
                                <input type="radio" formControlName="isPaid" value="no"
                                    (change)="togglePaidRating(false)" />
                                No
                            </label>
                        </div>
                    </div>

                    <div class="form-group" *ngIf="showPaidRating">
                        <label>How do you rate your paid version?</label>
                        <div class="star-rating">
                            <i *ngFor="let star of ratings" class="star"
                                [class.filled]="star <= reviewForm.get('paidVersionRating')?.value"
                                (click)="setRating('paidVersionRating', star)">‚òÖ</i>
                            <span class="rating-text">{{ reviewForm.get('paidVersionRating')?.value }}/5</span>
                        </div>
                    </div>

                    <!-- Additional Comments -->
                    <div class="form-group">
                        <label>Other Comments</label>
                        <textarea formControlName="additionalComments"
                            placeholder="Add your comments here..."></textarea>
                    </div>

                    <button type="submit" [disabled]="reviewForm.invalid || isSubmittingReview" class="submit-btn">
                        {{ isSubmittingReview ? (isEditingReview ? 'Updating...' : 'Submitting...') : (isEditingReview ?
                        'Update Review' : 'Submit Review') }}
                    </button>
                </form>
            </div>
        </div>
    </div>




    <div class="product-header" *ngIf="productDetails">
        <img [src]="productDetails.productimage || '../../../assets/images/12.png'" alt="User" class="product-image-sm"
            (click)="openPopup()" />
        <div class="image-popup-overlay" *ngIf="showPopup" (click)="closePopup()">
            <div class="image-popup" (click)="$event.stopPropagation()">
                <button class="close-btn" (click)="closePopup()">‚úñ</button>
                <img [src]="productDetails.productimage || '../../../assets/images/12.png'" alt="User Enlarged" />
            </div>
        </div>
        <div class="product-info">
            <h2 class="product-title">{{ productDetails.productname }}
                <span class="rating" [style.color]="getRatingColor(productDetails.rating)">
                    <span *ngIf="!isCalculatingRating">
                        ‚òÖ {{ productDetails.rating | number:'1.1-1' }} / 5
                    </span>
                    <span *ngIf="isCalculatingRating" class="calculating-rating">
                        Calculating...
                    </span>
                </span>
            </h2>

            <!-- Rating Breakdown -->
            <div class="rating-breakdown" *ngIf="ratingData && ratingData.num_reviews > 0">
                <div class="rating-summary">
                    <span class="rating-stars-display" [style.color]="getRatingColor(productDetails.rating)">
                        {{ getProductRatingStars(productDetails.rating) }}
                    </span>
                    <span class="review-count">({{ ratingData.num_reviews }} {{ ratingData.num_reviews === 1 ? 'review'
                        : 'reviews' }})</span>
                </div>

                <!-- Detailed breakdown - shown on hover or click -->
                <div class="rating-details" *ngIf="ratingData">
                    <div class="rating-item-detail">
                        <span class="label">Core Average:</span>
                        <span class="value">{{ ratingData.core_avg }}/5</span>
                    </div>
                    <div class="rating-item-detail" *ngIf="ratingData.paid_support_avg">
                        <span class="label">Paid Support:</span>
                        <span class="value">{{ ratingData.paid_support_avg }}/5</span>
                    </div>
                </div>
            </div>

            <p class="description">
                {{ productDetails.productdescription }}
            </p>
            <div class="social-media-icons">
                <a *ngIf="productDetails.productlinkedin" [href]="productDetails.productlinkedin" target="_blank">
                    <img src="../../../assets/images/linkedin.png" alt="LinkedIn" class="social-icon" />
                </a>
                <a *ngIf="productDetails.productfb" [href]="productDetails.productfb" target="_blank">
                    <img src="../../../assets/images/facebook.png" alt="Facebook" class="social-icon" />
                </a>
            </div>
        </div>
    </div>

    <div class="details-section" *ngIf="productDetails">
        <h3 class="section-heading">Product Details</h3>

        <div class="details-list">
            <!-- Use Cases -->
            <div class="detail-item" *ngIf="productDetails.useCases.length">
                <span class="detail-label">Use Cases:</span>
                <div class="detail-content">
                    <div class="chip-wrapper">
                        <span class="chip" *ngFor="let uc of productDetails.useCases">{{ uc }}</span>
                    </div>
                </div>
            </div>

            <!-- Repositories -->
            <div class="detail-item" *ngIf="productDetails.repositories.length">
                <span class="detail-label">Repositories:</span>
                <div class="detail-content">
                    <div class="chip-wrapper">
                        <span class="chip" *ngFor="let r of productDetails.repositories">{{ r }}</span>
                    </div>
                </div>
            </div>

            <!-- Founders -->
            

            <!-- Technology -->
            <div class="detail-item" *ngIf="productDetails.producttechnology.length">
                <span class="detail-label">Technology:</span>
                <div class="detail-content">
                    <div class="chip-wrapper">
                        <span class="chip" *ngFor="let t of productDetails.producttechnology">{{ t }}</span>
                    </div>
                </div>
            </div>

            <!-- Base AI Model -->
            <div class="detail-item" *ngIf="productDetails.baseModels.length">
                <span class="detail-label">Base AI Model:</span>
                <div class="detail-content">
                    <div class="chip-wrapper">
                        <span class="chip" *ngFor="let b of productDetails.baseModels">{{ b }}</span>
                    </div>
                </div>
            </div>

            <!-- Deployment -->
            <div class="detail-item" *ngIf="productDetails.deployments.length">
                <span class="detail-label">Deployment:</span>
                <div class="detail-content">
                    <div class="chip-wrapper">
                        <span class="chip" *ngFor="let d of productDetails.deployments">{{ d }}</span>
                    </div>
                </div>
            </div>

            

            <!-- License -->
            <div class="detail-item">
                <span class="detail-label">License:</span>
                <div class="detail-content">
                    <span class="detail-value">{{ productDetails.productlicense }}</span>
                </div>
            </div>

            <!-- Type -->
            <div class="detail-item">
                <span class="detail-label">Type:</span>
                <div class="detail-content">
                    <span class="detail-value">{{ productDetails.productcategory }}</span>
                </div>
            </div>

           


             <div class="detail-item">
                <span class="detail-label">X Link:</span>
                <div class="detail-content">
                    <a *ngIf="productDetails.xlink" [href]="productDetails.xlink" target="_blank"
                        class="detail-link">
                        {{ productDetails.xlink }}
                    </a>
                    <span *ngIf="!productDetails.xlink" class="detail-value detail-no-data">Not
                        available</span>
                </div>
            </div>


            <!-- Documentation -->
            <div class="detail-item">
                <span class="detail-label">Documentation:</span>
                <div class="detail-content">
                    <a *ngIf="productDetails.productdocumentation" [href]="productDetails.productdocumentation"
                        target="_blank" class="detail-link">
                        {{ productDetails.productdocumentation }}
                    </a>
                    <span *ngIf="!productDetails.productdocumentation" class="detail-value detail-no-data">Not
                        available</span>
                </div>
            </div>
        </div>
    </div>




    

     <div class="details-section" *ngIf="productDetails">
        <h3 class="section-heading">Company Details</h3>
         <div class="details-list">
            <div class="detail-item" *ngIf="productDetails.founders.length">
                <span class="detail-label">Founders:</span>
                <div class="detail-content">
                    <div class="chip-wrapper">
                        <span class="chip" *ngFor="let f of productDetails.founders">{{ f }}</span>
                    </div>
                </div>
            </div>


            <!-- Funding Stage -->
            <div class="detail-item">
                <span class="detail-label">Funding Stage:</span>
                <div class="detail-content">
                    <span class="detail-value">{{ productDetails.productfundingstage }}</span>
                </div>
            </div>

             <!-- Website -->
            <div class="detail-item">
                <span class="detail-label">Website:</span>
                <div class="detail-content">
                    <a *ngIf="productDetails.productwebsite" [href]="productDetails.productwebsite" target="_blank"
                        class="detail-link">
                        {{ productDetails.productwebsite }}
                    </a>
                    <span *ngIf="!productDetails.productwebsite" class="detail-value detail-no-data">Not
                        available</span>
                </div>
            </div>



         </div>


     </div>







    <!-- Media Previews Section -->
    <div class="media-section" *ngIf="productDetails?.mediaPreviews?.length">
        <h3 class="section-heading">Media Previews</h3>
        <div class="media-grid">
            <a *ngFor="let m of productDetails?.mediaPreviews" [href]="m.includes('youtube') ? m : null" target="_blank"
                [class.disabled-link]="!m.includes('youtube')" class="media-item">
                <img [src]="m.includes('youtube') ? '../../../assets/images/youtube.png' : '../../../assets/images/12.png'"
                    alt="Preview" class="media-thumbnail" />
            </a>
        </div>
    </div>




    <div class="reviews">
        <h3>User Reviews ({{ totalReviews }})</h3>
        <div class="review-holder" *ngIf="reviews.length > 0; else noReviews">
            <app-review-card *ngFor="let review of reviews" [review]="review" [currentUserId]="userid"
                [showMenu]="review.userid === userid" (reviewDeleted)="handleReviewDeleted($event)">
            </app-review-card>
        </div>

        <ng-template #noReviews>
            <div class="no-reviews">
                <div class="no-reviews-icon">üìù</div>
                <h4>No reviews yet</h4>
                <p>Be the first to review this product!</p>
            </div>
        </ng-template>

        <!-- Load More Button with Loading State -->
        <div class="load-more-container" *ngIf="hasMoreReviews">
            <button class="loadmorebtn" (click)="loadMoreReviews()" [disabled]="isLoadingMoreReviews">
                <span *ngIf="!isLoadingMoreReviews">Load More Reviews</span>
                <span *ngIf="isLoadingMoreReviews">Loading...</span>
                <svg *ngIf="!isLoadingMoreReviews" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
                <div *ngIf="isLoadingMoreReviews" class="loading-spinner"></div>
            </button>
            <p class="reviews-counter">Showing {{ reviews.length }} of {{ totalReviews }} reviews</p>
        </div>

        <!-- Show when all reviews are loaded -->
        <div class="all-reviews-loaded" *ngIf="!hasMoreReviews && reviews.length > 0">
            <p>All reviews loaded</p>
        </div>
    </div>
</div>

<div class="toast-message" [ngClass]="messageClass" [style.opacity]="messageVisible ? 1 : 0">
    {{ message }}
</div>